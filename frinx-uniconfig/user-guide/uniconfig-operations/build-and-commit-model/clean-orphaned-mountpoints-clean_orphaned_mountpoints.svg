<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
     contentScriptType="application/ecmascript" contentStyleType="text/css" height="621px" preserveAspectRatio="none"
     style="width:778px;height:621px;background:#FFFFFF;" version="1.1" viewBox="0 0 778 621" width="778px"
     zoomAndPan="magnify">
    <defs>
        <filter height="300%" id="fqxp4ovjuaf91" width="300%" x="-1" y="-1">
            <feGaussianBlur result="blurOut" stdDeviation="2.0"/>
            <feColorMatrix in="blurOut" result="blurOut2" type="matrix"
                           values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/>
            <feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/>
            <feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/>
        </filter>
    </defs>
    <g>
        <text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="259" x="257.75"
              y="28.708">Clean orphaned mountpoints
        </text>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="457.1875" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="235" y="98.25"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="239.2578" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="387.5" y="206.7813"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="457.1875" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="538.5" y="98.25"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="383.9219" style="stroke:#000000;stroke-width:2.0;"
              width="616.5" x="148" y="134.3828"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="352.7891" style="stroke:#000000;stroke-width:2.0;"
              width="596.5" x="158" y="158.5156"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="81" x2="81" y1="88.25"
              y2="564.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="240" x2="240" y1="88.25"
              y2="564.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="392" x2="392" y1="214.7969"
              y2="564.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="543.5" x2="543.5" y1="88.25"
              y2="564.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="681.5" x2="681.5" y1="324.8594"
              y2="564.4375"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="5"
              y="84.9482">TransactionManager
        </text>
        <ellipse cx="81.5" cy="55.9531" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <line style="stroke:#A80036;stroke-width:2.0;" x1="69.5" x2="93.5" y1="69.9531" y2="69.9531"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="5"
              y="576.4326">TransactionManager
        </text>
        <ellipse cx="81.5" cy="595.7344" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <line style="stroke:#A80036;stroke-width:2.0;" x1="69.5" x2="93.5" y1="609.7344" y2="609.7344"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="168"
              y="84.9482">MountpointRegistry
        </text>
        <ellipse cx="240" cy="55.9531" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="236,43.9531,242,38.9531,240,43.9531,242,48.9531,236,43.9531"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="138" x="168"
              y="576.4326">MountpointRegistry
        </text>
        <ellipse cx="240" cy="595.7344" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="236,583.7344,242,578.7344,240,583.7344,242,588.7344,236,583.7344"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="322"
              y="576.4326">UnmountNodeTask
        </text>
        <ellipse cx="392.5" cy="595.7344" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="388.5,583.7344,394.5,578.7344,392.5,583.7344,394.5,588.7344,388.5,583.7344"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="477.5"
              y="84.9482">SouthboundLayer
        </text>
        <ellipse cx="543.5" cy="55.9531" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="539.5,43.9531,545.5,38.9531,543.5,43.9531,545.5,48.9531,539.5,43.9531"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126" x="477.5"
              y="576.4326">SouthboundLayer
        </text>
        <ellipse cx="543.5" cy="595.7344" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="539.5,583.7344,545.5,578.7344,543.5,583.7344,545.5,588.7344,539.5,583.7344"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <rect fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;"
              width="121" x="619.5" y="563.4375"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="626.5"
              y="583.4326">NetworkDevice
        </text>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="457.1875" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="235" y="98.25"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="239.2578" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="387.5" y="206.7813"/>
        <rect fill="#FFFFFF" filter="url(#fqxp4ovjuaf91)" height="457.1875" style="stroke:#A80036;stroke-width:1.0;"
              width="10" x="538.5" y="98.25"/>
        <polygon fill="#A80036" points="223,115.3828,233,119.3828,223,123.3828,227,119.3828"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="229" y1="119.3828" y2="119.3828"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="88.5"
              y="114.3169">trigger cleanup
        </text>
        <path d="M148,134.3828 L224,134.3828 L224,141.3828 L214,151.3828 L148,151.3828 L148,134.3828 " fill="#EEEEEE"
              style="stroke:#000000;stroke-width:1.0;"/>
        <rect fill="none" height="383.9219" style="stroke:#000000;stroke-width:2.0;" width="616.5" x="148"
              y="134.3828"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing"
              textLength="31" x="163" y="147.4497">loop
        </text>
        <text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing"
              textLength="150" x="239" y="146.5933">["for each mountpoint"]
        </text>
        <path d="M158,158.5156 L227,158.5156 L227,165.5156 L217,175.5156 L158,175.5156 L158,158.5156 " fill="#EEEEEE"
              style="stroke:#000000;stroke-width:1.0;"/>
        <rect fill="none" height="352.7891" style="stroke:#000000;stroke-width:2.0;" width="596.5" x="158"
              y="158.5156"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing"
              textLength="24" x="173" y="171.5825">opt
        </text>
        <text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing"
              textLength="339" x="242" y="170.7261">["mountpoint is not referenced from any transaction"]
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="320" x2="310" y1="196.7813" y2="192.7813"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="320" x2="310" y1="196.7813" y2="200.7813"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="245" x2="321" y1="196.7813"
              y2="196.7813"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="41" x="252"
              y="191.7153">create
        </text>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="322"
              y="220.6436">UnmountNodeTask
        </text>
        <ellipse cx="392.5" cy="191.6484" fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" rx="12" ry="12"
                 style="stroke:#A80036;stroke-width:2.0;"/>
        <polygon fill="#A80036" points="388.5,179.6484,394.5,174.6484,392.5,179.6484,394.5,184.6484,388.5,179.6484"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="385.5" x2="375.5" y1="255.0781" y2="251.0781"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="385.5" x2="375.5" y1="255.0781" y2="259.0781"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="245" x2="386.5" y1="255.0781" y2="255.0781"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="252"
              y="250.0122">call
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="536.5" x2="526.5" y1="284.2109" y2="280.2109"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="536.5" x2="526.5" y1="284.2109" y2="288.2109"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="397.5" x2="537.5" y1="284.2109" y2="284.2109"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="404.5"
              y="279.145">disconnect device
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="617.5" x2="607.5" y1="313.3438" y2="309.3438"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="617.5" x2="607.5" y1="313.3438" y2="317.3438"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="548.5" x2="618.5" y1="313.3438"
              y2="313.3438"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="21" x="555.5"
              y="308.2778">get
        </text>
        <rect fill="#FEFECE" filter="url(#fqxp4ovjuaf91)" height="30.2969" style="stroke:#A80036;stroke-width:1.5;"
              width="121" x="619.5" y="292.2109"/>
        <text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="107" x="626.5"
              y="312.2061">NetworkDevice
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="680" x2="670" y1="358.6406" y2="354.6406"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="680" x2="670" y1="358.6406" y2="362.6406"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="548.5" x2="681" y1="358.6406" y2="358.6406"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="109" x="555.5"
              y="353.5747">close connection
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="548.5" x2="558.5" y1="387.7734" y2="383.7734"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="548.5" x2="558.5" y1="387.7734" y2="391.7734"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="548.5" x2="681" y1="387.7734"
              y2="387.7734"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="565.5"
              y="382.7075">ack
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="397.5" x2="407.5" y1="416.9063" y2="412.9063"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="397.5" x2="407.5" y1="416.9063" y2="420.9063"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="397.5" x2="537.5" y1="416.9063"
              y2="416.9063"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="414.5"
              y="411.8403">future
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="245" x2="255" y1="446.0391" y2="442.0391"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="245" x2="255" y1="446.0391" y2="450.0391"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="245" x2="391.5" y1="446.0391"
              y2="446.0391"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="39" x="262"
              y="440.9731">future
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="245" x2="287" y1="490.3047" y2="490.3047"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="287" x2="287" y1="490.3047" y2="503.3047"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="246" x2="287" y1="503.3047" y2="503.3047"/>
        <polygon fill="#A80036" points="256,499.3047,246,503.3047,256,507.3047,252,503.3047"
                 style="stroke:#A80036;stroke-width:1.0;"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="252"
              y="470.106">remove registered
        </text>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="256"
              y="485.2388">mountpoint
        </text>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="91.5" y1="546.4375" y2="542.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;" x1="81.5" x2="91.5" y1="546.4375" y2="550.4375"/>
        <line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="81.5" x2="234" y1="546.4375"
              y2="546.4375"/>
        <text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="23" x="98.5"
              y="541.3716">ack
        </text><!--MD5=[11b65ffcc10ef96b4b061a4b58ae3df1]
@startuml
title "Clean orphaned mountpoints"

entity TransactionManager
control MountpointRegistry
control UnmountNodeTask
control SouthboundLayer
participant NetworkDevice

activate MountpointRegistry
activate SouthboundLayer

TransactionManager -> MountpointRegistry: trigger cleanup
loop "for each mountpoint"
    opt "mountpoint is not referenced from any transaction"
        MountpointRegistry - ->> UnmountNodeTask**: create
        activate UnmountNodeTask
        MountpointRegistry ->> UnmountNodeTask: call

        UnmountNodeTask ->> SouthboundLayer: disconnect device
        SouthboundLayer - ->> NetworkDevice**: get
        SouthboundLayer ->> NetworkDevice: close connection
        NetworkDevice - ->> SouthboundLayer: ack
        SouthboundLayer - ->> UnmountNodeTask: future

        UnmountNodeTask - ->> MountpointRegistry: future
        deactivate UnmountNodeTask
        MountpointRegistry -> MountpointRegistry: remove registered\n mountpoint
    end
end

MountpointRegistry - ->> TransactionManager: ack
@enduml

PlantUML version 1.2021.11(Sat Oct 02 15:26:11 CEST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: GB
-->
    </g>
</svg>